# Swallow & Disgorge

## 目的
在推荐业务的场景中，我们经常面临一个问题，那就是如何处理bad case并进行分析。如果没有相应的日志记录，我们将无从分析。因此，第一件事就是要记录这些日志。但是，记录详细的日志可能会导致数据量过大，所以我们需要采用一种高效的方式来记录。此外，由于记录日志的成本可能很高，我们需要找到一种低成本的存储方式。最后，由于bad case并不是经常出现的情况，我们需要以低成本的方式解决查询问题。我们的目标就是用低成本的方式来解决这个问题。


## 设计架构
我们将存储和查询分成了两个项目：Swallow和Disgorge。Swallow用于存储日志，Disgorge用于查询日志，并实现了存算分离。

1. Swallow

日志按照小时进行轮转，并写入网络磁盘，以进行整理和存档。网络磁盘的使用可以使得整个架构具有以下优点：

- 大容量：网络磁盘可以提供大容量存储，可以很好地适应大量数据的存储需求。

- 低成本：相对于其他存储介质，网络磁盘可以提供更低的成本，并且在存储介质的选择方面更加灵活。

Rocksdb配置用于保证数据的可靠性和性能。当发生时间片轮转时，之前的Rocksdb将不再接受新的写入。但是我们会对其进行compact处理，这样可以提高之后以openforreadonly模式读取日志的性能。

1. Disgorge

查询通过DSL定义进行，可以根据时间范围查询数据。支持文件打开方式包括openassecondary和openforreadonly。

- Openassecondary：将文件以只读方式打开，如果有其他进程在写入，将等待写入完成后读取。适用于对数据实时性要求不高的大量读取场景。

- Openforreadonly：将文件以共享读写方式打开，能够读取到最新的内容，同时其他进程也可以读写。适用于对数据实时性要求较高的场景。


在日志正在写入时，或者已经进行了时间片轮转但尚未进行compact操作，有查询服务进来的时候，我们将使用openassecondary模式打开Rocksdb。对于其他情况，我们则用openforreadonly模式打开。此外，每次查询时我们都会重新独立打开Rocksdb的文件，查询结束后再关闭。


## 部署

1. Docker镜像

使用Docker镜像进行部署，可以方便地部署和管理服务，并且可以适应不同的环境需求。

2. Terraform部署

使用Terraform进行部署可以实现自动化部署和资源管理，极大地提高部署效率。
